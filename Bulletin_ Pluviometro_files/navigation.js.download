var wl = wl || {};

wl.app.module("oNavigation", function (oNavigation, oApp, Backbone, Marionette, $, _) {

    /**
     * switch between bulletin and summary views
     */

    var $bulletinViewBtn = $('#bulletin-view'),
        $summaryViewBtn = $('#summary-view'),
        $leftPanel = $('#scroll-container'),
        $rightPanel = $('#right-panel'),
        $navLinksArr = $('.nav-secondary .view-options a');
        $scrollContainer = $('#scroll-container');
        $viewOptions = $('.view-options');
        bulletinScrollPos = 0;
        summaryScrollPos = 0;

    this.bulletinNavigation = function () {

        $bulletinViewBtn.show().addClass('active');
        $summaryViewBtn.show();

        $navLinksArr.click(function (e) {
            var targetElem = e.target.tagName === 'I' ? e.target.parentElement : e.target;
            if ($(targetElem).prop('href').indexOf('http') === -1) {
                return;
            }
            e.preventDefault();
            if (targetElem.id === 'bulletin-view' && !$(targetElem).hasClass('active')) {
                oNavigation.showBulletin();
            } else if (targetElem.id === 'summary-view' && !$(targetElem).hasClass('active')) {
                oNavigation.showSummary();
            }
            if ($scrollContainer.perfectScrollbar) {
                $scrollContainer.perfectScrollbar('update');
            }
        });
    };

    this.showBulletin = function () {
        summaryScrollPos = $scrollContainer.scrollTop();
        $leftPanel.children().show();
        wl.app.Dashboard.trigger('tile:repack');
        $leftPanel.children('#summary').hide();
        $leftPanel.find('#print-summary').hide();
        $rightPanel.find('.summary-sensor-list').hide();
        $rightPanel.find('.js-accordion').show();
        $rightPanel.find('.sensor-list .right-panel-bottom').show();
        $navLinksArr.removeClass('active');
        $bulletinViewBtn.addClass('active');
        oNavigation.highlightNodeLinks();
        sessionStorage.removeItem("showSummaryView");
        $scrollContainer.scrollTop(bulletinScrollPos);
    };

    this.showSummary = function () {
        bulletinScrollPos = $scrollContainer.scrollTop();
        $leftPanel.children('#dashboard').hide();
        $leftPanel.children('#summary').show();
        $leftPanel.find('#print-summary').show();
        $leftPanel.children().find('.devices-dropdown').css('margin-right', 0);
        $rightPanel.find('.summary-sensor-list').show();
        $rightPanel.find('.js-accordion').hide();
        $rightPanel.find('.sensor-list .right-panel-bottom').hide();
        $navLinksArr.removeClass('active');
        $summaryViewBtn.addClass('active');
        oNavigation.highlightNodeLinks();
        sessionStorage.setItem("showSummaryView", "true");
        $scrollContainer.scrollTop(summaryScrollPos);
    };

    this.highlightNodeLinks = function () {
        if ($(".summary-sensor-list").length) {
            var aChildren = $(".summary-sensor-list li").children();
            var aArray = [];
            for (var i = 0; i < aChildren.length; i++) {
                var aChild = aChildren[i];
                var ahref = $(aChild).attr('href');
                if (ahref !== '#' && ahref !== '') {
                    aArray.push(ahref);
                }
            }
            if (aArray.length == 0) return;

            var scrollContainerPos = $scrollContainer.scrollTop();
            var scrollContainerHeight = $scrollContainer.height();
            var docHeight = $('#summary > div').height();

            for (var i = 0; i < aArray.length; i++) {
                // fixed header height + margins
                var header = $('.wl-table-title h3').get(0);                
                if (!header) return; //there is no table   
                var theID = aArray[i];
                var HEADER_OFFSET = 20;
                var divPos = $(theID).get(0).offsetTop - HEADER_OFFSET;
                var divHeight = $(theID).closest('.wl-table').height();
                if (scrollContainerPos >= divPos && scrollContainerPos < (divPos + divHeight)) {
                    $("a[href='" + theID + "']").addClass("active");
                } else {
                    $("a[href='" + theID + "']").removeClass("active");
                    if (scrollContainerPos <= 80) {
                        $("a[href='" + aArray[0] + "']").addClass("active");
                    }
                }
            }

            if (scrollContainerPos + scrollContainerHeight >= docHeight) {
                if (!$(".summary-sensor-list li:last-child a").hasClass("active")) {
                    var navActiveCurrent = $(".summary-sensor-list li a.active").attr("href");
                    $("a[href='" + navActiveCurrent + "']").removeClass("active");
                    $(".summary-sensor-list li:last-child a").addClass("active");
                }
            }
        }
    };

    $(document).ready(function () {
        oNavigation.bulletinNavigation();
        if (sessionStorage.getItem("showSummaryView") === 'true' && !$viewOptions.is(':hidden')) {
            oNavigation.showSummary();
        }

        $scrollContainer.scroll(function () {
            oNavigation.highlightNodeLinks();
        });
    });
});