/**
 * Created by anton.milko on 20-May-20.
 */
var wl = wl || {};
wl.data = wl.data || {};

wl.app.module("SearchDropdown", function (oModule, oApp) {

  this.on('start', function () {
    oApp.addRegions({
      dropDownRegion: ".search-dropdown",
    });
    //search dropdown list
    oApp.dropDownRegion.show(new this.SearchDropdownLayoutView());
  });

  this.stationsCollection = new Backbone.Collection();

  this.locationsCollection = new Backbone.Collection();

  this.SearchDropdownLayoutView = Marionette.LayoutView.extend({
    template: wl.shared.tpl['search-dropdown-layout'],
    className: 'option dropdown devices-dropdown open',
    regions: {
      stations: '#stations',
      locations: '#locations',
    },
    ui: {
      'stationTab': '.station-tab',
      'locationTab': '.location-tab',
      'tab': '.type-tab'
    },
    events: {
      'click @ui.stationTab': 'showStations',
      'click @ui.locationTab': 'showLocations',
      'click @ui.tab': 'onClickTab'
    },
    childEvents: {},
    onRender: function () {
    },
    onBeforeShow: function () {
      this.showChildView('stations', new StationsListView());
      this.showChildView('locations', new LocationsListView());
      this.showStations();
    },
    showStations: function () {
      this.hideAllViews();
      this.stations.$el.show();
      this.ui.stationTab.addClass('active')
    },
    showLocations: function () {
      this.hideAllViews();
      this.locations.$el.show().trigger('googleSearchShow');
      this.ui.locationTab.addClass('active')
    },
    hideAllViews: function () {
      this.stations.$el.hide();
      this.locations.$el.hide();
      this.ui.tab.removeClass('active')
    },
    onClickTab: function (e) {
      e.stopPropagation();
      oModule.trigger('click:tab');
    },
  });

  this.StationsListItemView = Marionette.ItemView.extend({
    template: wl.shared.tpl['search-dropdown-station-item'],
    model: Backbone.Model,
    tagName: 'li'
  });

  this.LocationsListItemView = this.StationsListItemView.extend({
    template: wl.shared.tpl['search-dropdown-location-item'],
  });

  //search dropdown stations list
  var StationsListView = Marionette.CompositeView.extend({
    template: _.template('<ul class="dropdown-devices-ul">'),
    className: 'devices-container',
    childView: this.StationsListItemView,
    childViewContainer: '.dropdown-devices-ul',
    collection: this.stationsCollection,
    ui: {
      devicesList: 'ul'
    },
    initialize: function () {
    	oModule.on('click:tab', this.updateScroll.bind(this));
      this.$el.on('click', function(e) {
        e.stopPropagation();
      });
      this.collection.on('add reset', _.debounce(function () {
        this.updateScroll();
      }.bind(this), 50));
    },
    updateScroll: function () {
    	$('#address').focus();
      if (this.$childViewContainer) {
        if (this.$childViewContainer.hasClass('ps-container')) {
          this.$childViewContainer.perfectScrollbar('update');
        } else {
          this.$childViewContainer.perfectScrollbar();
        }
        this.setMargin();
      }
    },
    setMargin: function () {
      if (this.$childViewContainer.hasClass('ps-active-y')) {
        this.ui.devicesList.css('margin-right', '10px');
      }
    }
  });

  var LocationsListView = StationsListView.extend({
    template: _.template('<ul class="dropdown-devices-ul google-img"></ul>' +
      '<div class="google-img-divider"></div><div class="google-img-container"></div>'),
    collection: this.locationsCollection,
    childView: this.LocationsListItemView,
  });
});