/**
 * Created by anton.milko on 17-Aug-18.
 */
var wl = wl || {};

wl.app.module('oWhatsNew', function(oWhatsNew, oWhatsNewApp, Backbone,
                                     Marionette, $, _) {
    oWhatsNew.startWithParent = false;

    // Initializer
    oWhatsNew.on('start', function() {
        this.show();
    });

    var ComparePlansModalView = wl.davis.views.ComparePlansView.extend({
        template: wl.shared.tpl['selectTier'],
        ui: {
            'mainContainer': '.subscription-info-container',
            'headers': '.compare-plans-header, .compare-plans-subheader',
            'historical_data_tooltip': '#historical_data_tooltip',
            'bulletin_tooltip': '#bulletin_tooltip',
            'map_tooltip': '#map_tooltip',
            'chart_tooltip': '#chart_tooltip',
            'data_tooltip': '#data_tooltip',
            'mobilize_tooltip': '#mobilize_tooltip',
            'ipm_tooltip': '#ipm_tooltip',
            'pro_shares_tooltip': '#pro_shares_tooltip',
            'third_party_intervals_tooltip': '#third_party_intervals_tooltip'
        },
        events: {
            'click .icon-close': 'returnToCarousel'
        },
        returnToCarousel: function() {
            var modal = this.$el.closest('.modal-dialog');
            var index = modal.attr('class').indexOf('slide-') + 6;
            var slideNumber;
            if (index > 0) {
                slideNumber = modal.attr('class').charAt(index);
            }
            var mainView = new oWhatsNew.MainView();
            mainView.render();
            this.$el.closest('.modal-dialog').attr('class', 'modal-dialog whats-new'); 
            this.$el.html(mainView.$el);
            if (slideNumber) {
                mainView.renderSlideByNumber(slideNumber);
            }
        }
    });

    oWhatsNew.show = function() {
        oModalBodyView = new oWhatsNew.MainView();
        oModalFooterView = new Marionette.ItemView({
            template: false
        });
        oWhatsNewApp.Modal.showStandardModal('', oModalBodyView,
            oModalFooterView, 'whats-new');
    };

    oWhatsNew.MainView = Marionette.ItemView.extend({
        template: wl.shared.tpl['whats-new-carousel'],
        ui: {
            'close': '.icon-close',
            'upgradeLink': '.upgrade-link, .compare-tiers',
            'tooltip': '#share_tokens_tooltip',
            'mergeAccounts': '.merge-accounts',
            'carousel': '#whatsNewCarousel',
            'slide': '.carousel-inner .item',
            'indicators': '.carousel-indicators li'
        },
        events: {
            'click @ui.close': 'close',
            'click @ui.upgradeLink': 'openTierCompare',
            'click @ui.mergeAccounts': 'openMergeAccounts'
        },
        onRender: function () {
            document.l10n.formatValue('whats_new_desc_6_tooltip').then(function(value) {
                this.ui.tooltip.attr('title','<div>' + value + '</div>');
                this.ui.tooltip.tooltip();
            }.bind(this));
        },
        close: function() {
            oWhatsNewApp.Modal.hideModal();
        },
        renderSlideByNumber: function (slideNumber) {
            this.ui.slide.removeClass('active');
            this.ui.indicators.removeClass('active');
            this.ui.slide.eq(slideNumber-1).addClass('active');
            this.ui.indicators.eq(slideNumber-1).addClass('active');
        },
        openTierCompare: function (e) {
            var slideNumber = $(e.target).attr('data-number');
            var oModalBodyView = new ComparePlansModalView();
            var oModalFooterView = new Marionette.ItemView({
                template: false
            });
            oWhatsNewApp.Modal.showStandardModal('', oModalBodyView,
                oModalFooterView, 'select-tier-modal from-carousel slide-'+ slideNumber);
            $('[data-toggle="tooltip"]').tooltip();
        },
        openMergeAccounts: function () {
            var oModalBodyView = new wl.davis.views.MergeLayoutView();
            var oModalFooterView = new Marionette.ItemView({
                template: false
            });
            oWhatsNewApp.Modal.showStandardModal('', oModalBodyView,
                oModalFooterView, 'user-message-modal from-carousel');
            oModalBodyView.renderMergeAccountsView();
        }
    });
});